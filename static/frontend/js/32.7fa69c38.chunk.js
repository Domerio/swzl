"use strict";(self["webpackChunkfrontend"]=self["webpackChunkfrontend"]||[]).push([[32],{116:function(t,e,r){var a=r(6518),i=r(2652),s=r(9306),o=r(8551),n=r(1767);a({target:"Iterator",proto:!0,real:!0},{find:function(t){o(this),s(t);var e=n(this),r=0;return i(e,(function(e,a){if(t(e,r++))return a(e)}),{IS_RECORD:!0,INTERRUPTED:!0}).result}})},2489:function(t,e,r){var a=r(6518),i=r(9565),s=r(9306),o=r(8551),n=r(1767),l=r(9462),c=r(6319),u=r(6395),d=l((function(){var t,e,r,a=this.iterator,s=this.predicate,n=this.next;while(1){if(t=o(i(n,a)),e=this.done=!!t.done,e)return;if(r=t.value,c(a,s,[r,this.counter++],!0))return r}}));a({target:"Iterator",proto:!0,real:!0,forced:u},{filter:function(t){return o(this),s(t),new d(n(this),{predicate:t})}})},2529:function(t){t.exports=function(t,e){return{value:t,done:e}}},4032:function(t,e,r){r.r(e),r.d(e,{default:function(){return p}});var a=function(){var t=this,e=t._self._c;return e("div",{staticClass:"lost-item-hall"},[e("h1",[t._v("🔍 招领大厅")]),e("el-row",{staticClass:"toolbar",attrs:{gutter:20}},[e("el-col",{staticClass:"search-item",attrs:{xs:24,sm:12,md:8}},[e("el-input",{staticClass:"search-input",attrs:{placeholder:"物品名称/描述...",clearable:""},on:{clear:t.handleFilter,keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleFilter.apply(null,arguments)}},scopedSlots:t._u([{key:"prefix",fn:function(){return[e("i",{staticClass:"el-icon-search input-icon"})]},proxy:!0}]),model:{value:t.searchQuery,callback:function(e){t.searchQuery=e},expression:"searchQuery"}})],1),e("el-col",{staticClass:"search-item",attrs:{xs:24,sm:12,md:8}},[e("el-select",{staticClass:"type-selector",attrs:{placeholder:"选择分类",clearable:"",filterable:""},on:{change:t.handleFilter},model:{value:t.filterType,callback:function(e){t.filterType=e},expression:"filterType"}},t._l(t.categories,(function(r){return e("el-option",{key:r.value,attrs:{label:r.label,value:r.value,disabled:r.hasChildren}},[e("span",{staticClass:"category-option",style:{paddingLeft:20*r.level+"px"}},[t._v(" "+t._s(r.label)+" "),r.hasChildren?e("i",{staticClass:"el-icon-folder-opened"}):t._e()])])})),1)],1),e("el-col",{staticClass:"search-item",attrs:{xs:24,sm:24,md:8}},[e("el-input",{staticClass:"location-input",attrs:{placeholder:"输入地址关键词...",clearable:""},on:{clear:t.handleFilter,keyup:function(e){return!e.type.indexOf("key")&&t._k(e.keyCode,"enter",13,e.key,"Enter")?null:t.handleFilter.apply(null,arguments)}},scopedSlots:t._u([{key:"prefix",fn:function(){return[e("i",{staticClass:"el-icon-location-information input-icon"})]},proxy:!0},{key:"append",fn:function(){return[e("el-button",{attrs:{type:"primary",icon:"el-icon-search"},on:{click:t.handleFilter}})]},proxy:!0}]),model:{value:t.locationQuery,callback:function(e){t.locationQuery=e},expression:"locationQuery"}})],1)],1),e("el-table",{directives:[{name:"loading",rawName:"v-loading",value:t.loading,expression:"loading"}],attrs:{data:t.filteredItems,"header-cell-style":{background:"#f8f9fa"}},scopedSlots:t._u([{key:"empty",fn:function(){return[e("div",{staticClass:"empty-state"},[e("i",{staticClass:"el-icon-document-remove"}),e("span",[t._v("当前没有可显示的招领信息")])])]},proxy:!0}])},[e("el-table-column",{attrs:{prop:"title",label:"物品名称","min-width":"180"},scopedSlots:t._u([{key:"default",fn:function({row:r}){return[e("span",{staticClass:"text-ellipsis"},[t._v(t._s(r.title))])]}}])}),e("el-table-column",{attrs:{label:"类型",width:"100"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.getItemTypeLabel(e.item_type))+" ")]}}])}),e("el-table-column",{attrs:{prop:"category",label:"分类",width:"120"},scopedSlots:t._u([{key:"default",fn:function({row:r}){return[e("el-tag",{attrs:{effect:"plain"}},[t._v(t._s(r.category_name))])]}}])}),e("el-table-column",{attrs:{label:"丢失时间",width:"150"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(t.formatTime(e.lost_time))+" ")]}}])}),e("el-table-column",{attrs:{label:"丢失地点",width:"200"},scopedSlots:t._u([{key:"default",fn:function({row:e}){return[t._v(" "+t._s(e.location)+" ")]}}])}),e("el-table-column",{attrs:{label:"状态",width:"100",align:"center"},scopedSlots:t._u([{key:"default",fn:function({row:r}){return[e("el-tag",{staticClass:"status-tag",attrs:{type:t.statusTypeMap[r.status],effect:"light"}},[t._v(" "+t._s(r.status)+" ")])]}}])}),e("el-table-column",{attrs:{label:"操作",width:"100"},scopedSlots:t._u([{key:"default",fn:function({row:r}){return[e("el-button",{attrs:{type:"primary",size:"small"},on:{click:function(e){return t.viewDetails(r)}}},[t._v("查看详情")])]}}])})],1),e("el-dialog",{attrs:{title:"🔍 物品详情",visible:t.detailDialogVisible,width:"800px","custom-class":"item-detail-dialog"},on:{"update:visible":function(e){t.detailDialogVisible=e}}},[e("el-row",{attrs:{gutter:20}},[e("el-col",{attrs:{span:8}},[e("el-carousel",{attrs:{interval:5e3,height:"300px",arrow:"always"}},t._l(t.currentItem.images,(function(t,r){return e("el-carousel-item",{key:r},[e("el-image",{staticClass:"detail-image",attrs:{src:t,fit:"cover"}},[e("div",{staticClass:"image-error",attrs:{slot:"error"},slot:"error"},[e("i",{staticClass:"el-icon-picture-outline"})])])],1)})),1)],1),e("el-col",{attrs:{span:16}},[e("el-descriptions",{attrs:{column:2,border:"","label-class-name":"detail-label"}},[e("el-descriptions-item",{attrs:{label:"物品名称"}},[t._v(t._s(t.currentItem.title))]),e("el-descriptions-item",{attrs:{label:"物品分类"}},[t._v(" "+t._s(t.currentItem.category_name)+" ")]),e("el-descriptions-item",{attrs:{label:"提交人"}},["admin"===t.currentItem.user?.role?e("el-tooltip",{attrs:{content:"管理员账号"}},[e("i",{staticClass:"el-icon-s-custom"})]):t._e(),t._v(" "+t._s(t.currentItem.user?.real_name||"匿名用户")+" "),t.currentItem.user?e("span",{staticClass:"user-role-tag"},[t._v(" ("+t._s(t.roleMap[t.currentItem.user.role])+") ")]):t._e()],1),e("el-descriptions-item",{attrs:{label:"拾取时间"}},[t._v(" "+t._s(t.formatTime(t.currentItem.lost_time))+" ")]),e("el-descriptions-item",{attrs:{label:"拾取地点"}},[t._v(" "+t._s(t.currentItem.location)+" "),t.currentItem.location_lat&&t.currentItem.location_lng?e("div",{staticClass:"detail-map-container",attrs:{id:"detail-map-"+t.currentItem.id}}):t._e()]),e("el-descriptions-item",{attrs:{label:"发布类型"}},[t._v(" "+t._s("lost"===t.currentItem.item_type?"失物登记":"招领登记")+" ")]),e("el-descriptions-item",{attrs:{label:"当前状态"}},[e("el-tag",{attrs:{type:t.statusTypeMap[t.currentItem.status],size:"medium"}},[t._v(" "+t._s(t.statusTextMap[t.currentItem.status])+" ")])],1),e("el-descriptions-item",{attrs:{label:"登记时间"}},[t._v(" "+t._s(t.formatTime(t.currentItem.created_at))+" ")]),e("el-descriptions-item",{attrs:{label:"详细描述",span:2}},[e("pre",{staticClass:"description-pre"},[t._v(t._s(t.currentItem.description))])])],1)],1)],1),e("span",{attrs:{slot:"footer"},slot:"footer"},[e("el-button",{attrs:{type:"warning"},on:{click:function(e){return t.sendNotification(t.currentItem.id)}}},[t._v("通知失主")]),e("el-button",{attrs:{type:t.bookmarked?"success":"primary",icon:t.bookmarked?"el-icon-star-off":"el-icon-star-on"},on:{click:t.handleBookmark}},[t._v(" "+t._s(t.bookmarked?"已收藏":"收藏物品")+" ")]),e("el-button",{on:{click:function(e){t.detailDialogVisible=!1}}},[t._v("关闭")])],1)],1)],1)},i=[],s=(r(4114),r(8111),r(2489),r(116),r(8237),r(4335)),o=r(4353),n=r.n(o),l={data(){return{searchQuery:"",locationQuery:"",filterType:null,typeOptions:[],categories:[],lostItems:[],loading:!1,detailDialogVisible:!1,currentItem:{},statusTypeMap:{pending:"warning",active:"primary",completed:"success",expired:"info"},statusTextMap:{pending:"待审核",active:"进行中",completed:"已完成",expired:"已过期"},bookmarked:!1}},methods:{formatTime(t){return n()(t).format("YYYY-MM-DD HH:mm:ss")},handleFilter(){this.fetchLostItems(this.filterParams)},async fetchCategories(){try{const t=await s.A.get("/api/found/categories/tree/");this.categories=this.convertToFlatOptions(t.data)}catch(t){console.error("获取分类失败",t)}},convertToFlatOptions(t){const e=t=>t.reduce(((t,r)=>(t.push({value:r.id,label:r.name,hasChildren:r.children&&r.children.length>0}),r.children&&t.push(...e(r.children)),t)),[]);return e(t)},async fetchLostItems(){this.loading=!0;try{const t=await s.A.get("/api/public/found-items/",{headers:{Authorization:`Token ${this.$store.state.token}`,"X-CSRFToken":this.getCSRFToken()}});this.lostItems=t.data}catch(t){console.error("获取招领信息失败",t)}finally{this.loading=!1}},async checkBookmarkStatus(){try{const t=await s.A.get(`/api/bookmarks/${this.currentItem.id}/`,{headers:{Authorization:`Token ${this.$store.state.token}`,"X-CSRFToken":this.getCSRFToken()}});this.bookmarked=t.data.bookmarked}catch(t){console.error("获取收藏状态失败",t)}},getCSRFToken(){const t=document.cookie.split("; ").find((t=>t.startsWith("csrftoken=")))?.split("=")[1]||"";return t},async handleBookmark(){try{const t={headers:{Authorization:`Token ${this.$store.state.token}`,"X-CSRFToken":this.getCSRFToken(),"Content-Type":"application/json"}},e=this.bookmarked?"delete":"post";await s.A[e](`/api/bookmarks/${this.currentItem.id}/`,"delete"===e?t:null,"post"===e?t:null),this.bookmarked=!this.bookmarked,this.$message.success(this.bookmarked?"收藏成功":"已取消收藏")}catch(t){console.error("操作收藏失败",t),this.$message.error(`操作失败: ${t.response?.data?.error||"未知错误"}`)}},viewDetails(t){this.$store.state.token?(this.currentItem=t,this.detailDialogVisible=!0,this.checkBookmarkStatus()):this.$message.warning("请先登录")},initDetailMap(){if(!window.AMap)return void this.$message.warning("地图资源正在加载，请稍候");const t=parseFloat(this.currentItem.location_lng),e=parseFloat(this.currentItem.location_lat);if(isNaN(t)||isNaN(e))return;this.destroyDetailMap();const r=`detail-map-${this.currentItem.id}`,a=document.getElementById(r);if(!a)return;this.detailMap=new AMap.Map(r,{zoom:17,center:[t,e],resizeEnable:!0});const i=new AMap.Scale,s=new AMap.ToolBar({position:{bottom:"20px",right:"20px"}});i.addTo(this.detailMap),s.addTo(this.detailMap),new AMap.Marker({position:[t,e],content:'<div class="location-pin">📍</div>',map:this.detailMap})},destroyDetailMap(){if(this.detailMap){try{this.detailMap.destroy()}catch(t){console.warn("地图销毁过程中出现警告:",t.message)}this.detailMap=null}},getItemTypeLabel(t){return{lost:"失物登记",found:"招领登记"}[t]||"未知类型"},async sendNotification(t){try{await s.A.post(`/api/report-lost/${t}/`,{},{headers:{Authorization:`Token ${this.$store.state.token}`,"X-CSRFToken":this.getCSRFToken()}}),this.$message.success("通知已发送")}catch(e){console.error("发送通知失败",e),this.$message.error("操作失败，请重试")}}},mounted(){if(this.fetchCategories(),this.fetchLostItems(),!window.AMap){const t="db70318a1cf1f196b2746f10cb9df826",e=["AMap.Scale","AMap.ToolBar"].join(","),r=document.createElement("script");r.src=`https://webapi.amap.com/maps?v=2.0&key=${t}&plugin=${e}`,r.onerror=()=>{console.error("高德地图SDK加载失败")},document.head.appendChild(r)}},computed:{roleMap(){return{admin:"管理员",teacher:"教职工",student:"学生"}},filteredItems(){const t=this.searchQuery.toLowerCase(),e=this.locationQuery.toLowerCase();return this.lostItems.filter((r=>(r.title.toLowerCase().includes(t)||r.description.toLowerCase().includes(t))&&r.location.toLowerCase().includes(e)&&(!this.filterType||r.category===this.filterType)))}},watch:{detailDialogVisible(t){t?this.$nextTick((()=>{this.currentItem.location_lat&&this.currentItem.location_lng&&this.initDetailMap()})):this.destroyDetailMap()}}},c=l,u=r(1656),d=(0,u.A)(c,a,i,!1,null,"b1091dd0",null),p=d.exports},6279:function(t,e,r){var a=r(6840);t.exports=function(t,e,r){for(var i in e)a(t,i,e[i],r);return t}},6319:function(t,e,r){var a=r(8551),i=r(9539);t.exports=function(t,e,r,s){try{return s?e(a(r)[0],r[1]):e(r)}catch(o){i(t,"throw",o)}}},8237:function(t,e,r){var a=r(6518),i=r(2652),s=r(9306),o=r(8551),n=r(1767),l=TypeError;a({target:"Iterator",proto:!0,real:!0},{reduce:function(t){o(this),s(t);var e=n(this),r=arguments.length<2,a=r?void 0:arguments[1],c=0;if(i(e,(function(e){r?(r=!1,a=e):a=t(a,e,c),c++}),{IS_RECORD:!0}),r)throw new l("Reduce of empty iterator with no initial value");return a}})},9462:function(t,e,r){var a=r(9565),i=r(2360),s=r(6699),o=r(6279),n=r(8227),l=r(1181),c=r(5966),u=r(7657).IteratorPrototype,d=r(2529),p=r(9539),h=n("toStringTag"),m="IteratorHelper",f="WrapForValidIterator",y=l.set,k=function(t){var e=l.getterFor(t?f:m);return o(i(u),{next:function(){var r=e(this);if(t)return r.nextHandler();if(r.done)return d(void 0,!0);try{var a=r.nextHandler();return r.returnHandlerResult?a:d(a,r.done)}catch(i){throw r.done=!0,i}},return:function(){var r=e(this),i=r.iterator;if(r.done=!0,t){var s=c(i,"return");return s?a(s,i):d(void 0,!0)}if(r.inner)try{p(r.inner.iterator,"normal")}catch(o){return p(i,"throw",o)}return i&&p(i,"normal"),d(void 0,!0)}})},g=k(!0),b=k(!1);s(b,h,"Iterator Helper"),t.exports=function(t,e,r){var a=function(a,i){i?(i.iterator=a.iterator,i.next=a.next):i=a,i.type=e?f:m,i.returnHandlerResult=!!r,i.nextHandler=t,i.counter=0,i.done=!1,y(this,i)};return a.prototype=e?g:b,a}}}]);
//# sourceMappingURL=32.7fa69c38.chunk.js.map